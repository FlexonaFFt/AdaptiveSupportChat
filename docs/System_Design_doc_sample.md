# ML System Design Doc - [RU]
## Дизайн ML системы - Warehouse Demand Simulation & Procurement System MVP v1

Источник требований: `docs/small.md`.
Статус: черновик для согласования.

### 1. Цели и предпосылки
#### 1.1. Зачем идем в разработку продукта?
- Бизнес-цель: снизить дефицит товара (stockout) и упущенные продажи (lost sales) при ограничениях бюджета и ёмкости склада.
- Почему лучше, чем текущий процесс: решения по закупке будут приниматься на основании прогноза спроса и истории продаж, а не вручную.
- Успех итерации: улучшение fill rate и снижение lost sales относительно бейзлайна (ручная/наивная закупка).

#### 1.2. Бизнес-требования и ограничения
- Требования:
  - Ежедневная симуляция спроса агентами-покупателями.
  - Учет списания остатков и lost sales.
  - Прогноз спроса на 7 дней по каждому SKU.
  - Формирование и исполнение плана закупки агентом-закупщиком.
  - Расчет бизнес- и ML-метрик.
- Ограничения:
  - Дискретный шаг времени: 1 день.
  - Покупатели не обучаются.
  - Обучается только ML-модель.
  - Закупщик работает с ограничениями по бюджету и складу.
- Использование в процессе пилота:
  - Ежедневно: симуляция -> обновление склада -> (по расписанию) обучение -> прогноз -> закупка -> исполнение.
- Критерий успешного пилота:
  - `TBD из Практических заданий.pdf`: пороговые значения по stockout/fill rate/lost sales.

#### 1.3. Что входит в скоуп итерации, что не входит
- Входит:
  - MVP пайплайн end-to-end от симуляции до отчета.
  - Одна базовая модель прогноза + один бейзлайн.
  - Rule-based оптимизация закупки.
  - CLI/API операции из ТЗ.
- Не входит:
  - Онлайн-обучение.
  - Продвинутый RL-закупщик.
  - Полноценный production orchestration (если не требуется для курса).
- Качество кода и воспроизводимость:
  - Фиксированный seed для симуляции.
  - Версионирование датасета/модели/конфига.
  - Повторяемый запуск сценариев через один entrypoint.
- Техдолг:
  - Упрощенный feature store.
  - Ограниченный мониторинг дрейфа.

#### 1.4. Предпосылки решения
- Горизонт прогноза: 7 дней.
- Гранулярность: day x SKU.
- Источники данных:
  - История продаж.
  - Остатки и история заказов.
  - Справочник SKU.
- Частота переобучения: 1 раз в неделю (на старте).

### 2. Методология
#### 2.1. Постановка задачи
- Техническая задача: multi-series demand forecasting + constrained replenishment planning.

#### 2.2. Блок-схема решения (MVP)
1. Симуляция дня (генерация спроса по SKU).
2. Обновление остатков и фиксация lost sales.
3. Запись фактов продаж/остатков в хранилище.
4. Периодическое обучение модели.
5. Инференс прогноза на 7 дней.
6. Расчет плана закупки с ограничениями.
7. Исполнение заказа и обновление остатков.
8. Расчет метрик и формирование отчета.

#### 2.3. Этапы решения задачи
Этап 1. Подготовка данных
- Сущности:
  - `sales_daily(sku_id, date, demand, sold, lost_sales)`
  - `inventory_daily(sku_id, date, on_hand)`
  - `orders(sku_id, date, qty, cost, eta_date, status)`
  - `sku_dim(sku_id, category, lead_time_days, min_order_qty, unit_cost)`
- Результат:
  - Витрина обучения с лагами, rolling-агрегатами, календарными фичами.

Этап 2. Бейзлайн прогноза
- Метод: seasonal naive / rolling mean.
- Метрики: MAE, RMSE, WAPE.
- Результат: контрольная линия качества и скорости.

Этап 3. MVP-модель прогноза
- Метод: LightGBM/CatBoost по SKU или pooled model с `sku_id` feature.
- Разбиение: time-based train/validation/test.
- Частота пересчета: weekly retrain, daily inference.
- Результат: прогноз `demand_hat` на 7 дней по SKU.

Этап 4. Планирование закупки
- Вход: прогноз, текущие остатки, открытые заказы, бюджет, ёмкость.
- Логика:
  - Целевой уровень = прогноз на горизонт + safety stock.
  - К закупке = max(0, целевой уровень - ожидаемый доступный остаток).
  - Ограничения: бюджет, min order qty, вместимость склада.
- Результат: order plan на день.

Этап 5. Оценка качества решения
- Бизнес-метрики: stockout rate, lost sales, fill rate, total sales.
- ML-метрики: MAE, RMSE, WAPE, bias.
- Результат: сравнение против бейзлайна закупки.

Риски и меры:
- Leakage в признаках -> строгий time split, запрет будущих признаков.
- Нестабильность спроса -> регуляризация, rolling retrain, safety stock.
- Плохой forecast для редких SKU -> fallback на бейзлайн.

### 3. Подготовка пилота
#### 3.1. Способ оценки пилота
- Дизайн: backtesting на историческом периоде + replay simulation.
- Сравнение: baseline закупка vs. forecast-driven закупка.

#### 3.2. Что считаем успешным пилотом
- `TBD из Практических заданий.pdf`:
  - минимальный прирост fill rate;
  - максимальный допустимый stockout rate;
  - снижение lost sales относительно бейзлайна;
  - ограничение роста запасов.

#### 3.3. Подготовка пилота
- Режим: дневные батчи.
- Вычислительные ограничения:
  - обучение <= 30 мин на цикл (цель для MVP);
  - инференс + планирование <= 10 мин в день.
- При превышении лимитов: упрощение фич/модели и уменьшение частоты retrain.

### 4. Внедрение (MVP уровень)
#### 4.1. Архитектура решения
- `simulator` -> `feature_pipeline` -> `train_service` -> `forecast_service` -> `procurement_service` -> `reporting`.
- Интерфейсы:
  - `run_day(date)`
  - `run_n_days(n)`
  - `train_model()`
  - `get_week_forecast(date)`
  - `create_procurement_plan(date)`

#### 4.2. Инфраструктура и масштабируемость
- Для MVP: single-node Python service + local DB/Parquet.
- Масштабирование: переход на job orchestrator и выделенный model registry.

#### 4.3. Требования к работе системы
- SLA MVP: завершение дневного цикла в рамках суток (batch до начала следующего дня).
- Точность: целевые метрики фиксируются по итогам пилота.

#### 4.4. Безопасность системы
- Контроль доступа к операциям изменения остатков и созданию заказов.
- Аудит-лог изменений.

#### 4.5. Безопасность данных
- PII отсутствует (SKU/агрегированные продажи), проверить по фактическим источникам.

#### 4.6. Издержки
- MVP: локальные вычисления + хранение табличных данных.
- `TBD`: оценка в деньгах при выборе финальной инфраструктуры.

#### 4.7. Integration points
- Складской модуль: чтение/запись остатков.
- Модуль заказов: создание и статус заказа.
- Отчетность: выгрузка метрик.

#### 4.8. Риски
- Модель может улучшать ML-метрики без улучшения бизнес-метрик.
- Ошибки lead time приводят к системному недозаказу.
- Данные симуляции могут плохо переноситься на реальный поток.
